#!/usr/bin/env sh
set -eu

# Collect staged PHP files (Added/Copied/Modified/Renamed)
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.php$' || true)

# If no PHP files staged, skip
if [ -z "${STAGED_PHP_FILES}" ]; then
  exit 0
fi

echo "Running PHP-CS-Fixer on staged files..."
# Apply fixes only to the intersection of the given paths
echo "${STAGED_PHP_FILES}" | tr '\n' '\0' | xargs -0 ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php --dry-run --diff --path-mode=intersection

# Re-stage files that were auto-fixed
echo "${STAGED_PHP_FILES}" | tr '\n' '\0' | xargs -0 git add

echo "Running Psalm..."
# Common: run psalm normally (fast with cache) as a commit gate
./vendor/bin/psalm

echo "Pre-commit checks passed."